forcedMode = null;
            if ([1, 2, 3].includes(currentBlock)) {
                forcedMode = Math.random() > 0.3 ? 'calculation' : 'lookup';
            }
            currentGuidedExercise = generateExercise(currentBlock, null, null, null, forcedMode);
            guidedStepIndex = 0;

            const questionContainer = document.getElementById('guidedExerciseContainer');
            questionContainer.innerHTML = `<p class="font-semibold text-gray-800 text-lg">${currentGuidedExercise.question}</p>`;

            const stepsContainer = document.getElementById('guidedStepsContainer');
            stepsContainer.innerHTML = '';

            document.getElementById('nextStepBtn').classList.remove('hidden');
            document.getElementById('newGuidedBtn').classList.add('hidden');
            displayNextGuidedStep();
        }

        function displayNextGuidedStep() {
            const stepsContainer = document.getElementById('guidedStepsContainer');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const lang = translations[currentLanguage];
            
            if (guidedStepIndex >= currentGuidedExercise.solutionSteps.length) {
                 const finalSolutionDiv = document.createElement('div');
                 finalSolutionDiv.className = 'step-container mt-4 p-3 bg-green-100 border border-green-300 rounded-md';
                 finalSolutionDiv.innerHTML = `<b>${lang.solution}:</b> ${currentGuidedExercise.solution}`;
                 stepsContainer.appendChild(finalSolutionDiv);

                nextStepBtn.classList.add('hidden');
                document.getElementById('newGuidedBtn').classList.remove('hidden');
                return;
            }

            const step = currentGuidedExercise.solutionSteps[guidedStepIndex];
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-container p-4 border-l-4 border-gray-300 bg-gray-50';

            if (step.type === 'text') {
                stepDiv.innerHTML = step.content;
                stepsContainer.appendChild(stepDiv);
                guidedStepIndex++;
                nextStepBtn.classList.remove('hidden');
            } else if (step.type === 'calculation') {
                stepDiv.innerHTML = `
                    <p>${step.text}</p>
                    <p class="font-mono text-indigo-600 my-2">${step.formula}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="number" id="guided-input-${guidedStepIndex}" class="guided-input" step="any" placeholder="${lang.result}" data-attempts="0">
                        <span class="text-gray-600">${step.unit || ''}</span>
                        <button class="btn btn-secondary !p-2 !text-sm" onclick="validateGuidedStepAnswer(${guidedStepIndex}, this)">${lang.check}</button>
                    </div>
                    <div id="guided-feedback-${guidedStepIndex}" class="mt-2 text-sm"></div>
                `;
                stepsContainer.appendChild(stepDiv);
                nextStepBtn.classList.add('hidden');
            }
        }

        function validateGuidedStepAnswer(stepIndex, buttonEl) {
            const step = currentGuidedExercise.solutionSteps[stepIndex];
            const input = document.getElementById(`guided-input-${stepIndex}`);
            const feedback = document.getElementById(`guided-feedback-${stepIndex}`);
            const userValue = input.value;
            const lang = translations[currentLanguage];

            if (!userValue) {
                feedback.innerHTML = `<span class="font-bold text-red-700">${lang.enterValue}</span>`;
                feedback.className = "mt-2 text-sm text-red-700";
                return;
            }

            let isCorrect = false;
            if (step.answerType === 'integer') {
                isCorrect = parseInt(userValue) === parseInt(step.correctValue);
            } else { // float by default
                 isCorrect = parseFloat(userValue).toFixed(2) === parseFloat(step.correctValue).toFixed(2);
            }

            if (isCorrect) {
                feedback.innerHTML = `<span class="font-bold text-green-700">${lang.correct}</span> ${step.fullSolution}`;
                feedback.className = "mt-2 text-sm text-green-700";
                input.disabled = true;
                buttonEl.disabled = true;
                guidedStepIndex++;
                document.getElementById('nextStepBtn').classList.remove('hidden');
            } else {
                let attempts = parseInt(input.dataset.attempts) + 1;
                input.dataset.attempts = attempts;

                if (attempts >= 2) {
                    feedback.innerHTML = `<span class="font-bold text-orange-700">${lang.correctWas} ${step.correctValue}.</span> ${step.fullSolution}`;
                    feedback.className = "mt-2 text-sm text-orange-700";
                    input.value = step.correctValue;
                    input.disabled = true;
                    input.classList.add('border-orange-500');
                    buttonEl.disabled = true;
                    guidedStepIndex++;
                    document.getElementById('nextStepBtn').classList.remove('hidden');
                } else {
                    feedback.innerHTML = `<span class="font-bold text-red-700">${lang.incorrect}</span> ${lang.oneAttemptLeft}`;
                    feedback.className = "mt-2 text-sm text-red-700";
                    input.value = '';
                    input.focus();
                }
            }
        }


        // --- INITIALIZATION ---
        window.onload = () => {
            populateStudents();
            setLanguage(currentLanguage);
            showScreen('loginScreen');
        };
    </script>
</body>
</html>


