<!DOCTYPE html>
    const traducciones = {
      es: {
        lang: "Castellano",
        loginTitle: "Acceso",
        langLabel: "Idioma:",
        userTypeLabel: "Tipo de usuario:",
        alumnoOpt: "Alumno",
        profesorOpt: "Profesor",
        alumnoNombreLabel: "Selecciona tu nombre:",
        profesorPassLabel: "Contraseña del profesor:",
        loginBtn: "Entrar",
        ejerciciosResueltos: "Ejercicios resueltos y explicados",
        siguiente: "Siguiente",
        respondeEjercicios: "Responde los ejercicios",
        enviarRespuestas: "Enviar respuestas",
        ejerciciosSeccion: "Ejercicios de sección y caída de tensión",
        enviarSeccion: "Enviar respuestas",
        alumnoFinal: "¡Has completado todos los ejercicios!",
        enhorabuena: "¡Enhorabuena!",
        panelProfesor: "Panel del Profesor",
        subirODS: "Subir ODS de alumnos:",
        informes: "Informes de tests realizados",
        noInformes: "No hay informes aún.",
        ver: "Ver",
        correcto: "Correcto",
        incorrecto: "Incorrecto",
        respuesta: "Respuesta",
        accesoIncorrecto: "Contraseña incorrecta",
        odsCargado: n => `ODS cargado correctamente (${n} alumnos).`,
        odsNoAlumnos: "No se encontraron alumnos válidos en el archivo.",
        ejercicio: i => `Ejercicio ${i}:`,
        solucion: "Solución:",
        explicacion: "Explicación:",
        respuestaA: "Respuesta (A):",
        respuestaS: "Respuesta (mm²):"
      },
      ca: {
        lang: "Català",
        loginTitle: "Accés",
        langLabel: "Idioma:",
        userTypeLabel: "Tipus d'usuari:",
        alumnoOpt: "Alumne",
        profesorOpt: "Professor",
        alumnoNombreLabel: "Selecciona el teu nom:",
        profesorPassLabel: "Contrasenya del professor:",
        loginBtn: "Entrar",
        ejerciciosResueltos: "Exercicis resolts i explicats",
        siguiente: "Següent",
        respondeEjercicios: "Respon els exercicis",
        enviarRespuestas: "Envia respostes",
        ejerciciosSeccion: "Exercicis de secció i caiguda de tensió",
        enviarSeccion: "Envia respostes",
        alumnoFinal: "Has completat tots els exercicis!",
        enhorabuena: "Enhorabona!",
        panelProfesor: "Panell del Professor",
        subirODS: "Puja ODS d'alumnes:",
        informes: "Informes de tests realitzats",
        noInformes: "Encara no hi ha informes.",
        ver: "Veure",
        correcto: "Correcte",
        incorrecto: "Incorrecte",
        respuesta: "Resposta",
        accesoIncorrecto: "Contrasenya incorrecta",
        odsCargado: n => `ODS carregat correctament (${n} alumnes).`,
        odsNoAlumnos: "No s'han trobat alumnes vàlids al fitxer.",
        ejercicio: i => `Exercici ${i}:`,
        solucion: "Solució:",
        explicacion: "Explicació:",
        respuestaA: "Resposta (A):",
        respuestaS: "Resposta (mm²):"
      }
    };
      <button id="submit-seccion-btn">Enviar respuestas</button>
    </div>

    <!-- Pantalla final alumno -->
    <div id="alumno-final" class="hidden">
      <h2>¡Has completado todos los ejercicios!</h2>
      <p>¡Enhorabuena!</p>
    </div>

    <!-- Pantalla profesor -->
    <div id="profesor-screen" class="hidden">
      <h2>Panel del Profesor</h2>
      <div class="professor-section">
        <label for="ods-upload">Subir ODS de alumnos:</label>
        <input type="file" id="ods-upload" accept=".ods" />
        <div id="ods-feedback"></div>
      </div>
      <div class="professor-section">
        <h3>Informes de tests realizados</h3>
        <div id="informes-list"></div>
      </div>
    </div>
  </div>
  <script>
    // --- Datos simulados de alumnos (se cargan desde ODS en la pantalla del profesor) ---
    let alumnos = [
      { nombre: "Alumno Ejemplo 1", email: "alumno1@email.com" },
      { nombre: "Alumno Ejemplo 2", email: "alumno2@email.com" }
    ];
    // --- Informes de tests realizados (se guardan en localStorage) ---
    let informes = JSON.parse(localStorage.getItem('informes') || '[]');

    // --- Utilidades ---
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    function randomFloat(min, max, decimals=2) {
      return parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
    }
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function uniqueExercises(generator, count) {
      const set = new Set();
      const result = [];
      while (result.length < count) {
        const ex = generator();
        const key = JSON.stringify(ex);
        if (!set.has(key)) {
          set.add(key);
          result.push(ex);
        }
      }
      return result;
    }

    // --- Login ---
    const userTypeSelect = document.getElementById('user-type');
    const alumnoLogin = document.getElementById('alumno-login');
    const profesorLogin = document.getElementById('profesor-login');
    const alumnoNombreSelect = document.getElementById('alumno-nombre');
    const loginBtn = document.getElementById('login-btn');
    let currentAlumno = null;

    function updateAlumnoSelect() {
      alumnoNombreSelect.innerHTML = '';
      alumnos.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.nombre;
        opt.textContent = a.nombre;
        alumnoNombreSelect.appendChild(opt);
      });
    }
    updateAlumnoSelect();

    userTypeSelect.addEventListener('change', () => {
      if (userTypeSelect.value === 'alumno') {
        alumnoLogin.classList.remove('hidden');
        profesorLogin.classList.add('hidden');
      } else {
        alumnoLogin.classList.add('hidden');
        profesorLogin.classList.remove('hidden');
      }
    });

    loginBtn.addEventListener('click', () => {
      if (userTypeSelect.value === 'alumno') {
        currentAlumno = alumnos.find(a => a.nombre === alumnoNombreSelect.value);
        if (currentAlumno) {
          showScreen('ejercicios-resueltos');
          generarEjerciciosResueltos();
        }
      } else {
        const pass = document.getElementById('profesor-pass').value;
        if (pass === 'Feanor') {
          showScreen('profesor-screen');
          renderInformes();
        } else {
          alert('Contraseña incorrecta');
        }
      }
    });

    // --- Pantallas ---
    function showScreen(id) {
      ['login-screen','ejercicios-resueltos','ejercicios-test','ejercicios-seccion','alumno-final','profesor-screen'].forEach(s => {
        document.getElementById(s).classList.add('hidden');
            alert(t('accesoIncorrecto'));
      document.getElementById(id).classList.remove('hidden');
    }

    // --- Ejercicios resueltos y explicados ---
    function generarEjerciciosResueltos() {
      const resueltos = uniqueExercises(generarEjercicioIntensidad, 10);
      const resueltosList = document.getElementById('resueltos-list');
      resueltosList.innerHTML = '';
      resueltos.forEach((ex, i) => {
        const div = document.createElement('div');
        div.className = 'exercise';
        div.innerHTML = `<b>Ejercicio ${i+1}:</b><br>${ex.enunciado}<br><b>Solución:</b> ${ex.solucion}<br><i>Explicación:</i> ${ex.explicacion}`;
        resueltosList.appendChild(div);
      });
    }
    document.getElementById('to-ejercicios-btn').onclick = () => {
      showScreen('ejercicios-test');
      generarEjerciciosTest();
    };

    // --- Generador de ejercicios de intensidad ---
    function generarEjercicioIntensidad() {
      // Monofásica o trifásica
      const tipo = Math.random() < 0.5 ? 'monofásica' : 'trifásica';
      const V = tipo === 'monofásica' ? 230 : 400;
      const P = randomInt(1000, 10000); // Potencia entre 1kW y 10kW
      const fp = randomFloat(0.7, 1, 2);
      let I, formula, explicacion;
      if (tipo === 'monofásica') {
        I = P / (V * fp);
        formula = `I = P / (V × fp)`;
        explicacion = `I = ${P} / (${V} × ${fp}) = ${I.toFixed(2)} A`;
      } else {
        I = P / (1.732 * V * fp);
        formula = `I = P / (1,732 × V × fp)`;
        explicacion = `I = ${P} / (1,732 × ${V} × ${fp}) = ${I.toFixed(2)} A`;
      }
      return {
        enunciado: `Calcular la intensidad para una línea <b>${tipo}</b> de <b>${V}V</b>, potencia <b>${P}W</b> y factor de potencia <b>${fp}</b>.`,
        solucion: `${I.toFixed(2)} A`,
        explicacion: `${formula}.<br>${explicacion}`,
        tipo, V, P, fp, I: I.toFixed(2)
      };
    }

    // --- Ejercicios para responder ---
    let ejerciciosTest = [];
    function generarEjerciciosTest() {
      ejerciciosTest = uniqueExercises(generarEjercicioIntensidad, 10);
      const form = document.getElementById('test-form');
      form.innerHTML = '';
      ejerciciosTest.forEach((ex, i) => {
        const div = document.createElement('div');
        div.className = 'exercise';
        div.innerHTML = `<b>Ejercicio ${i+1}:</b><br>${ex.enunciado}<br>
          <label>Respuesta (A): <input type="number" step="0.01" name="resp${i}" required></label>`;
        form.appendChild(div);
      });
      document.getElementById('test-feedback').innerHTML = '';
    }
    document.getElementById('submit-test-btn').onclick = (e) => {
      e.preventDefault();
      const form = document.getElementById('test-form');
      const data = new FormData(form);
      let correctas = 0;
      let feedback = '';
      ejerciciosTest.forEach((ex, i) => {
        const resp = parseFloat(data.get(`resp${i}`));
        const sol = parseFloat(ex.I);
        const ok = Math.abs(resp - sol) < 0.05; // margen de error
        if (ok) correctas++;
        feedback += `<div class="${ok ? 'correct' : 'incorrect'}">Ejercicio ${i+1}: ${ok ? 'Correcto' : `Incorrecto. Respuesta: ${sol} A`}</div>`;
      });
      document.getElementById('test-feedback').innerHTML = feedback;
      if (correctas === 10) {
        setTimeout(() => {
          showScreen('ejercicios-seccion');
          generarEjerciciosSeccion();
        }, 1200);
      } else {
        setTimeout(() => {
          generarEjerciciosTest();
        }, 2000);
      }
    };

    // --- Generador de ejercicios de sección y caída de tensión ---
    const conductividades = {
      cobre: { PVC: 48.47, XLPE: 45.49 },
      aluminio: { PVC: 29.67, XLPE: 27.8 }
    };
    const maxCaidas = [
      { tipo: 'LGA en contadores totalmente concentrados', pct: 0.5 },
      { tipo: 'LGA en contadores parcialmente concentrados', pct: 1 },
      { tipo: 'Derivación individual en contador único', pct: 1.5 },
      { tipo: 'Derivación individual en contadores totalmente concentrados', pct: 1 },
      { tipo: 'Derivación individual en contadores parcialmente concentrados', pct: 0.5 },
      { tipo: 'Circuitos interiores de viviendas', pct: 3 },
      { tipo: 'Circuitos de alumbrado que no sean de vivienda', pct: 3 },
      { tipo: 'Circuitos interiores que no son de vivienda ni alumbrado', pct: 5 }
    ];
    function generarEjercicioSeccion() {
      const tipoLinea = Math.random() < 0.5 ? 'monofásica' : 'trifásica';
      const V = tipoLinea === 'monofásica' ? 230 : 400;
      const P = randomInt(1000, 10000);
      const L = randomInt(10, 100); // Longitud
      const mat = Math.random() < 0.5 ? 'cobre' : 'aluminio';
      const aisl = Math.random() < 0.5 ? 'PVC' : 'XLPE';
      const cond = conductividades[mat][aisl];
      const caida = shuffle(maxCaidas)[0];
      const caidaAbs = V * (caida.pct / 100);
      let S, formula, explicacion;
      if (tipoLinea === 'monofásica') {
        S = (2 * P * L) / (V * caidaAbs * cond);
        formula = `S = (2 × P × L) / (V × ΔV × conductividad)`;
        explicacion = `S = (2 × ${P} × ${L}) / (${V} × ${caidaAbs.toFixed(2)} × ${cond}) = ${S.toFixed(2)} mm²`;
      } else {
        S = (P * L) / (V * caidaAbs * cond);
        formula = `S = (P × L) / (V × ΔV × conductividad)`;
        explicacion = `S = (${P} × ${L}) / (${V} × ${caidaAbs.toFixed(2)} × ${cond}) = ${S.toFixed(2)} mm²`;
      }
      return {
        enunciado: `Calcular la sección para una línea <b>${tipoLinea}</b> de <b>${V}V</b>, potencia <b>${P}W</b>, longitud <b>${L}m</b>, material <b>${mat}</b>, aislamiento <b>${aisl}</b>, caída máxima <b>${caida.pct}%</b> (${caida.tipo}).`,
        solucion: `${S.toFixed(2)} mm²`,
        explicacion: `${formula}.<br>${explicacion}`,
        tipoLinea, V, P, L, mat, aisl, cond, caida, caidaAbs: caidaAbs.toFixed(2), S: S.toFixed(2)
      };
    }
    let ejerciciosSeccion = [];
    function generarEjerciciosSeccion() {
      ejerciciosSeccion = uniqueExercises(generarEjercicioSeccion, 10);
      const form = document.getElementById('seccion-form');
      form.innerHTML = '';
      ejerciciosSeccion.forEach((ex, i) => {
        const div = document.createElement('div');
        div.className = 'exercise';
        div.innerHTML = `<b>Ejercicio ${i+1}:</b><br>${ex.enunciado}<br>
          <label>Respuesta (mm²): <input type="number" step="0.01" name="resp${i}" required></label>`;
        form.appendChild(div);
      });
      document.getElementById('seccion-feedback').innerHTML = '';
    }
    document.getElementById('submit-seccion-btn').onclick = (e) => {
      e.preventDefault();
      const form = document.getElementById('seccion-form');
      const data = new FormData(form);
      let correctas = 0;
      let feedback = '';
      ejerciciosSeccion.forEach((ex, i) => {
        const resp = parseFloat(data.get(`resp${i}`));
        const sol = parseFloat(ex.S);
        const ok = Math.abs(resp - sol) < 0.05;
        if (ok) correctas++;
        feedback += `<div class="${ok ? 'correct' : 'incorrect'}">Ejercicio ${i+1}: ${ok ? 'Correcto' : `Incorrecto. Respuesta: ${sol} mm²`}</div>`;
      });
      document.getElementById('seccion-feedback').innerHTML = feedback;
      if (correctas === 10) {
        // Guardar informe
        if (currentAlumno) {
          informes.push({ alumno: currentAlumno.nombre, email: currentAlumno.email, fecha: new Date().toLocaleString(), ejercicios: ejerciciosSeccion });
          localStorage.setItem('informes', JSON.stringify(informes));
        }
        setTimeout(() => {
          showScreen('alumno-final');
        }, 1200);
      } else {
        setTimeout(() => {
          generarEjerciciosSeccion();
        }, 2000);
      }
    };

    // --- Profesor: subir ODS y ver informes ---
    document.getElementById('ods-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        // Intentar leer ODS como texto plano CSV (simple, para demo)
        const text = evt.target.result;
        // Buscar filas tipo: nombre,email
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        const nuevos = [];
        lines.forEach(line => {
          const [nombre, email] = line.split(',');
          if (nombre && email) nuevos.push({ nombre: nombre.trim(), email: email.trim() });
        });
        if (nuevos.length) {
          alumnos = nuevos;
          updateAlumnoSelect();
          document.getElementById('ods-feedback').innerHTML = `<span class="correct">ODS cargado correctamente (${nuevos.length} alumnos).</span>`;
        } else {
          document.getElementById('ods-feedback').innerHTML = `<span class="incorrect">No se encontraron alumnos válidos en el archivo.</span>`;
        }
      };
      reader.readAsText(file);
    });
    function renderInformes() {
      const div = document.getElementById('informes-list');
      if (!informes.length) {
        div.innerHTML = '<i>No hay informes aún.</i>';
        return;
      }
      let html = '<table><tr><th>Alumno</th><th>Email</th><th>Fecha</th><th>Ejercicios</th></tr>';
      informes.forEach(inf => {
        html += `<tr><td>${inf.alumno}</td><td>${inf.email}</td><td>${inf.fecha}</td><td><button onclick='alert("Ver detalles no implementado en demo")'>Ver</button></td></tr>`;
      });
      html += '</table>';
      div.innerHTML = html;
    }
  </script>
</body>
</html>
